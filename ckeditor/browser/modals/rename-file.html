<div class="modal-subfolder fade modal-common" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content rounded-0">
            <div class="modal-header p-1">
                <h5 class="modal-title" id="modalLabel">Rename</h5>
                <button type="button" class="border-0 bg-transparent close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="folder" class="pb-1">Type the new file name:</label>
                    <input type="text" class="form-control" name="folder" id="folder" aria-describedby="folderHelp" placeholder="Enter your filename" />
                </div>
                <div class="mt-1 error_msg error hidden"></div>
            </div>
            <div class="modal-footer p-1">
                <div class="cancelok">
                    <button type="button" class="btn btn-primary btn-sm pt-0 pb-0 border-secondary rounded-0 ok modal-save">Save</button>
                    <button type="button" class="btn btn-secondary btn-sm pt-0 pb-0 border-secondary rounded-0 close" data-dismiss="modal">Cancel</button>
                </div>
                <!-- Show processing status -->
                <div class="loader" style="display: none;"></div>
            </div>
        </div>
    </div>
</div><!-- /.Modal -->

<script>
    function loadDataOnInput() {
        let oldFile = $('.wrap-modal-subfolder').data('path');
        let input = $('.wrap-modal-subfolder').find('#folder');
        input.val(getFileName(oldFile));
        // Focus after 1s
        setTimeout(function() {
            input.focus();
        }, 1000);
    }

    $(function () {
        loadDataOnInput();

        $(document).find('.modal-subfolder').modal('toggle');

        $(document).on('click', '.modal-subfolder .close', function () {
            $('.modal-subfolder').modal('hide');
        });

        $('.modal-subfolder').on('hide.bs.modal', function (e) {
            $('.wrap-modal-subfolder').remove();
        });

        $('.modal-subfolder').on('click', '.ok', function (e) {
            e.stopPropagation();
            e.preventDefault();

            let modal = $(this).closest('.modal-subfolder');
            let newFile = modal.find('input[name="folder"]').val().trim();

            if (!newFile) {
                alert('You must enter a filename!');
                return;
            }

            var charsNotAllowed = /[<>:"\/\\|?*\x00-\x1F]|^(?:aux|con|clock\$|nul|prn|com[1-9]|lpt[1-9])$/i;
            if (charsNotAllowed.test(newFile)) {
                alert('Filename contains invalid characters!');
                return;
            }

            let oldFile = $('.wrap-modal-subfolder').data('path');

            modal.find('.cancelok').hide();
            modal.find('.loader').show();

            let dataForm = new FormData();
            dataForm.append('action', 'rename');
            dataForm.append('old_file', oldFile);
            dataForm.append('new_file', newFile);

            $.ajax({
                url: '../uploader/do_file.php',
                method: 'POST',
                data: dataForm,
                dataType: 'json',
                contentType: false,
                cache: false,
                processData: false,
                success: function(response, status, jqXHR) {
                    console.log('response => ', response)
                    if (response && response.success) {
                        modal.modal('hide');
                    } else {
                        modal.find('.cancelok').show();
                        modal.find('.error_msg').html(response.error).show();

                        hideAfter(modal.find('.error_msg'));
                    }
                    modal.find('.loader').hide();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('error =>', jqXHR, textStatus, errorThrown);
                    modal.find('.cancelok').show();
                    modal.find('.error_msg').html(jqXHR.responseText).show();

                    hideAfter(modal.find('.error_msg'));
                }
            });
        });
    });
</script>
